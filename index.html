<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­Œå–®æµ·å ±ç”¢ç”Ÿå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root { --tag-scale: 1; }
        body { font-family: 'Noto Sans JP', 'Noto Sans TC', sans-serif; overflow: hidden; background-color: #18181b; }
        .ghost { opacity: 0.2; background: #3f3f46 !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .poster-size {
            width: 592px; height: 400px; position: relative; overflow: hidden;
            flex-shrink: 0; background-color: #2d5a3a; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .song-tag {
            background-color: rgba(0, 0, 0, 0.6); color: white;
            padding: calc(6px * var(--tag-scale)) calc(12px * var(--tag-scale)); 
            display: inline-block; transform: skewX(-5deg);
            margin-bottom: calc(3px * var(--tag-scale)); margin-left: calc(10px * var(--tag-scale));  
            border-right: calc(2px * var(--tag-scale)) solid rgba(255, 255, 255, 0.2);
            border-bottom: calc(2px * var(--tag-scale)) solid rgba(255, 255, 255, 0.2);
            text-align: left; min-width: fit-content; max-width: 90%; 
            transition: none; 
        }
        .song-tag.tag-white {
            background-color: rgba(255, 255, 255, 0.6); color: black;
            border-right: calc(2px * var(--tag-scale)) solid rgba(0, 0, 0, 0.3);
            border-bottom: calc(2px * var(--tag-scale)) solid rgba(0, 0, 0, 0.3);
        }
        .song-tag > .tag-inner { transform: skewX(5deg); display: flex; align-items: baseline; gap: calc(8px * var(--tag-scale)); }
        .tag-index { font-size: calc(13px * var(--tag-scale)); font-weight: 900; line-height: 1; flex-shrink: 0; min-width: calc(18px * var(--tag-scale)); text-align: right; font-style: italic; }
        .tag-name { font-size: calc(13px * var(--tag-scale)); font-weight: 900; line-height: 1; letter-spacing: 0.02em; white-space: nowrap; }
        .tag-album { font-size: calc(9px * var(--tag-scale)); font-weight: 400; opacity: 0.8; line-height: 1.2; margin-top: calc(3px * var(--tag-scale)); white-space: nowrap; }
        
        .content-layer { position: relative; z-index: 10; height: 100%; display: flex; flex-direction: column; padding: 24px; box-sizing: border-box; }
        .title-main { font-size: 1.8rem; font-weight: 900; line-height: 1.1; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .title-sub { font-size: 1rem; opacity: 0.8; padding-left: 1em; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        
        #playlist-items { display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-end; justify-content: flex-end; width: 100%; overflow: visible; }
        #capture-zone { background-repeat: no-repeat; background-size: cover; background-position: center; transform-origin: top center; }
        
        .tab-btn.active { border-bottom: 2px solid #22c55e; color: white; }
        input[type=range] { accent-color: #22c55e; height: 4px; border-radius: 2px; }
        .sortable-item { cursor: grab; user-select: none; }
    </style>
</head>
<body class="text-zinc-100 h-[100dvh] flex flex-col">

    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        <div class="flex-1 p-4 flex flex-col items-center bg-zinc-800 relative overflow-y-auto">
            <div id="scale-wrapper" class="w-full flex justify-center items-start pt-4 transition-all duration-300">
                <div id="capture-zone" class="poster-size shadow-2xl">
                    <div class="content-layer">
                        <div id="title-container" class="mb-3 flex-shrink-0">
                            <div class="title-main">è«‹åœ¨æ­¤è¼¸å…¥æ­Œå–®æ¨™é¡Œ</div>
                            <div class="title-sub">æ›è¡Œä»¥è¼¸å…¥å‰¯æ¨™é¡Œ</div>
                        </div>
                        <div id="playlist-items"></div>
                    </div>
                </div>
            </div>

            <div class="mt-6 w-full max-w-3xl bg-zinc-700/50 p-5 rounded-2xl border border-zinc-600 backdrop-blur-sm shadow-xl">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-3">
                        <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">æ¨™é¡Œæ–‡å­—</p>
                        <textarea id="nickname-input" rows="2" class="w-full bg-zinc-900/80 p-3 rounded-lg text-xs outline-none focus:ring-1 focus:ring-green-500 transition-all font-mono" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ­Œå–®æ¨™é¡Œï¼Œæ›è¡Œä»¥è¼¸å…¥å‰¯æ¨™é¡Œ">è«‹åœ¨æ­¤è¼¸å…¥æ­Œå–®æ¨™é¡Œ&#10;æ›è¡Œä»¥è¼¸å…¥å‰¯æ¨™é¡Œ</textarea>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="toggle-color" class="bg-zinc-600 hover:bg-zinc-500 py-2 rounded text-[10px] transition-colors">æ·±è‰²æ¨™é¡Œ/æ·ºè‰²æ¨™é¡Œ</button>
                            <button id="toggle-tag-color" class="bg-zinc-600 hover:bg-zinc-500 py-2 rounded text-[10px] transition-colors">æ·±è‰²æ­Œå–®/æ·ºè‰²æ­Œå–®</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">åº•åœ–èª¿æ•´</p>
                        <div class="space-y-3 pt-1">
                            <div class="flex flex-col gap-1"><div class="flex justify-between text-[9px] text-zinc-400"><span>åº•åœ–ç¸®æ”¾èª¿æ•´</span><span id="val-scale">100%</span></div><input type="range" id="bg-scale" min="100" max="300" value="100"></div>
                            <div class="flex flex-col gap-1"><div class="flex justify-between text-[9px] text-zinc-400"><span>åº•åœ–æ°´å¹³èª¿æ•´</span><span id="val-x">50%</span></div><input type="range" id="bg-x" min="0" max="100" value="50"></div>
                            <div class="flex flex-col gap-1"><div class="flex justify-between text-[9px] text-zinc-400"><span>åº•åœ–å‚ç›´èª¿æ•´</span><span id="val-y">50%</span></div><input type="range" id="bg-y" min="0" max="100" value="50"></div>
                        </div>
                    </div>
                    <div class="flex flex-col justify-between space-y-3">
                        <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">è¼¸å‡ºèˆ‡æª”æ¡ˆ</p>
                        <div class="flex-1 flex flex-col gap-2">
                            <label class="flex items-center justify-center gap-2 w-full bg-zinc-100 text-zinc-900 py-3 rounded-xl text-xs font-bold cursor-pointer hover:bg-white transition-all shadow-lg"><span>ğŸ“· ä¸Šå‚³åº•åœ–</span><input type="file" id="bg-upload" accept="image/*" class="hidden"></label>
                            <button id="export-btn" class="w-full bg-green-600 text-white font-black py-4 rounded-xl text-xs shadow-lg hover:bg-green-500 transition-all uppercase tracking-tighter">â¬‡ åŒ¯å‡ºåœ–ç‰‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full lg:w-[380px] h-[45vh] lg:h-auto bg-zinc-900 border-l border-zinc-800 p-5 flex flex-col">
            <div class="flex gap-6 border-b border-zinc-800 mb-5 text-sm font-bold">
                <button id="tab-edit" class="tab-btn pb-3 active transition-all" onclick="switchTab('edit')">ç›®å‰æ­Œå–®</button>
                <button id="tab-library" class="tab-btn pb-3 text-zinc-500 transition-all" onclick="switchTab('library')">ç¤¾ç¾¤æ­Œåº«</button>
            </div>
            
            <!-- ç·¨è¼¯å€åŸŸï¼šåŠ å…¥ Spotify æœå°‹ -->
            <div id="panel-edit" class="flex flex-col flex-1 overflow-hidden">
                <div class="mb-4 space-y-2">
                    <!-- Spotify ç™»å…¥å€ -->
                    <div id="spotify-login-area" class="hidden">
                        <button id="login-spotify-btn" class="w-full bg-[#1DB954] hover:bg-[#1ed760] text-black font-bold py-2.5 rounded-lg text-xs flex items-center justify-center gap-2 transition-colors">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141 4.32-1.38 9.841-.719 13.5 1.56.419.3.6.84.24 1.26zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.4-1.02 15.419 1.381.541.3.6.96.361 1.5-.3.54-.96.66-1.5.36z"/></svg>
                            ç™»å…¥ Spotify æœå°‹æ­Œæ›²
                        </button>
                    </div>

                    <!-- æœå°‹æ¡† (ç™»å…¥å¾Œé¡¯ç¤º) -->
                    <div id="spotify-search-area" class="hidden">
                        <div class="flex gap-2">
                            <input type="text" id="spotify-query" placeholder="è¼¸å…¥ Spotify æ­Œå..." class="flex-1 bg-zinc-800 p-2.5 rounded-lg text-xs border border-zinc-700 outline-none focus:border-[#1DB954]">
                            <button id="search-spotify-btn" class="bg-zinc-700 hover:bg-zinc-600 text-white px-3 rounded-lg text-xs">æœ</button>
                        </div>
                    </div>

                    <!-- æ‰‹å‹•è¼¸å…¥æŠ˜ç–Šå€ -->
                    <details class="group border border-zinc-800 rounded-lg bg-zinc-800/30 open:bg-zinc-800/50 transition-all">
                        <summary class="cursor-pointer p-2 text-[10px] text-zinc-400 select-none group-open:text-zinc-200 flex justify-between items-center">
                            <span>æ‰‹å‹•è¼¸å…¥ / ä¿®æ­£</span>
                            <span class="text-zinc-600 group-open:rotate-180 transition-transform">â–¼</span>
                        </summary>
                        <div class="p-3 pt-0 grid grid-cols-2 gap-2 mt-2">
                            <input type="text" id="custom-name" placeholder="æ­Œå" class="bg-zinc-900 p-2 rounded text-xs border border-zinc-700 outline-none">
                            <input type="text" id="custom-album" placeholder="å°ˆè¼¯" class="bg-zinc-900 p-2 rounded text-xs border border-zinc-700 outline-none">
                            <button id="add-custom-btn" class="col-span-2 bg-zinc-700 hover:bg-zinc-600 text-white py-2 rounded text-xs">+ åŠ å…¥</button>
                        </div>
                    </details>
                </div>

                <div class="text-[10px] text-zinc-500 text-center mb-2 italic">â€» è«‹ç›´æ¥åœ¨å·¦å´æµ·å ±ä¸Šæ‹–æ›³æ¨™ç±¤ä»¥æ’åº</div>
                <div id="playlist-list-ui" class="flex-1 overflow-y-auto space-y-2 no-scrollbar pr-1">
                    <!-- æœå°‹çµæœæˆ–æ­Œå–®æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                </div>
                <div class="flex justify-between items-center mt-4 border-t border-zinc-800 pt-3">
                    <button onclick="toggleBulkModal()" class="text-[11px] text-zinc-400 hover:text-white transition-colors underline decoration-dotted">æ‰¹æ¬¡åŒ¯å…¥æ–‡å­—</button>
                    <button id="clear-all-btn" class="text-[11px] text-red-500 hover:text-red-400 font-bold">æ¸…ç©ºå…¨éƒ¨</button>
                </div>
            </div>

            <div id="panel-library" class="hidden flex-1 flex flex-col overflow-hidden">
                <div class="relative mb-3">
                    <input type="text" id="library-search" placeholder="æœå°‹ç¤¾ç¾¤æ­Œåº«..." class="w-full bg-zinc-800 p-2.5 pl-8 rounded-lg text-xs border border-zinc-700 outline-none">
                    <span class="absolute left-3 top-2.5 opacity-30 text-xs">ğŸ”</span>
                </div>
                <div id="library-list-ui" class="flex-1 overflow-y-auto space-y-2 pr-1 no-scrollbar"></div>
            </div>
        </div>
    </div>

    <!-- Modal ç•¥... -->
    <div id="bulk-modal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
        <div class="bg-zinc-800 p-8 rounded-2xl w-full max-w-md border border-zinc-700 shadow-2xl">
            <h3 class="font-bold text-lg mb-2">æ‰¹æ¬¡åŒ¯å…¥</h3>
            <p class="text-[10px] text-zinc-500 mb-4">è«‹ä¾ç…§ã€Œæ­Œå,å°ˆè¼¯ã€æ ¼å¼è¼¸å…¥ï¼Œä¸€è¡Œä¸€é¦–ã€‚</p>
            <textarea id="bulk-input" rows="8" class="w-full bg-zinc-900 p-4 rounded-xl text-xs mb-6 outline-none focus:ring-1 focus:ring-green-500" placeholder="æ­Œæ›²åç¨±,å°ˆè¼¯åç¨±&#10;ç©´ã‚’æ˜ã£ã¦ã„ã‚‹,ãƒœã‚¤ã‚³ãƒƒãƒˆ"></textarea>
            <div class="flex gap-3">
                <button onclick="toggleBulkModal()" class="flex-1 bg-zinc-700 py-3 rounded-xl text-xs font-bold">å–æ¶ˆ</button>
                <button id="bulk-import-btn" class="flex-1 bg-green-600 py-3 rounded-xl text-xs font-bold">é–‹å§‹åŒ¯å…¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === æ‰‹å‹•è¨­å®šå€ (æ³¨æ„å®‰å…¨) ===
        const manualConfig = {
            apiKey: "AIzaSyDhP9JryXni2a6SOka73Lgng80DBwg0esI",
  authDomain: "my-setlist-25d7a.firebaseapp.com",
  projectId: "my-setlist-25d7a",
  storageBucket: "my-setlist-25d7a.firebasestorage.app",
  messagingSenderId: "723230839513",
  appId: "1:723230839513:web:307d5221fada859e6f24c8"
        };

        // === 2. è«‹å¡«å…¥ Spotify Client ID ===
        const spotifyClientId = "1ed974a9278b46a0af69f3e112977dc8"; // åœ¨æ­¤å¡«å…¥ä½ çš„ Spotify Client ID
        
        // è‡ªå‹•åµæ¸¬ç›®å‰çš„ç¶²å€ä½œç‚º Redirect URI (å¿…é ˆèˆ‡ Spotify Dashboard è¨­å®šå®Œå…¨ä¸€è‡´)
        const redirectUri = window.location.origin + window.location.pathname;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : manualConfig;
        let db = null, auth = null, user = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-poster-app';
        let allLibrarySongs = [];
        let spotifyToken = null;

        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                const startAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) { console.warn("é©—è­‰å¤±æ•—:", err); }
                };
                onAuthStateChanged(auth, (u) => { user = u; if (user) listenToLibrary(); });
                startAuth();
            } catch(e) { console.error("Firebase Init Error", e); }
        }

        // Spotify Auth: ä½¿ç”¨ PKCE æµç¨‹
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function initiateSpotifyLogin() {
            if (!spotifyClientId) { alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ Spotify Client ID"); return; }
            
            const codeVerifier = generateRandomString(128);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const state = generateRandomString(16);
            const scope = 'user-read-private';

            localStorage.setItem('spotify_code_verifier', codeVerifier);

            const args = new URLSearchParams({
                response_type: 'code',
                client_id: spotifyClientId,
                scope: scope,
                redirect_uri: redirectUri,
                state: state,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });

            window.location.href = 'https://accounts.spotify.com/authorize?' + args;
        }

        async function handleSpotifyCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            // å¦‚æœç¶²å€æœ‰ codeï¼Œä»£è¡¨æ˜¯ Spotify å°å›ä¾†çš„
            if (code) {
                const codeVerifier = localStorage.getItem('spotify_code_verifier');
                if (!codeVerifier) return; // æ²’æœ‰ verifierï¼Œå¯èƒ½æ˜¯ç•°å¸¸è¨ªå•

                const body = new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: redirectUri,
                    client_id: spotifyClientId,
                    code_verifier: codeVerifier
                });

                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: body
                    });

                    if (!response.ok) throw new Error('Token exchange failed');

                    const data = await response.json();
                    spotifyToken = data.access_token;
                    
                    // UI æ›´æ–°
                    document.getElementById('spotify-login-area').classList.add('hidden');
                    document.getElementById('spotify-search-area').classList.remove('hidden');
                    
                    // æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œé¿å…é‡æ–°æ•´ç†å¾Œå‡ºéŒ¯
                    window.history.replaceState({}, document.title, window.location.pathname);
                    localStorage.removeItem('spotify_code_verifier');
                } catch (err) {
                    console.error(err);
                    alert("Spotify ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Client ID æˆ– Redirect URI è¨­å®š");
                }
            } else {
                // å¦‚æœæ²’æœ‰ codeï¼Œé¡¯ç¤ºç™»å…¥æŒ‰éˆ•
                document.getElementById('spotify-login-area').classList.remove('hidden');
                document.getElementById('spotify-search-area').classList.add('hidden');
            }
        }

        // å•Ÿå‹•é©—è­‰æª¢æŸ¥
        handleSpotifyCallback();

        document.getElementById('login-spotify-btn').onclick = initiateSpotifyLogin;

        // Spotify æœå°‹é‚è¼¯
        document.getElementById('search-spotify-btn').onclick = async () => {
            const query = document.getElementById('spotify-query').value;
            if (!query || !spotifyToken) return;
            
            const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`, {
                headers: { 'Authorization': 'Bearer ' + spotifyToken }
            });
            
            if (res.ok) {
                const data = await res.json();
                renderSpotifyResults(data.tracks.items);
            } else if (res.status === 401) {
                alert("Spotify ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥");
                document.getElementById('spotify-login-area').classList.remove('hidden');
                document.getElementById('spotify-search-area').classList.add('hidden');
                spotifyToken = null;
            }
        };

        // é¡¯ç¤º Spotify æœå°‹çµæœ
        function renderSpotifyResults(tracks) {
            const ui = document.getElementById('playlist-list-ui');
            ui.innerHTML = ''; 
            
            const backBtn = document.createElement('div');
            backBtn.className = 'text-center text-xs text-zinc-400 py-2 cursor-pointer hover:text-white border-b border-zinc-700 mb-2';
            backBtn.innerText = 'â† è¿”å›ç›®å‰æ­Œå–®';
            backBtn.onclick = () => syncOrderFromPoster(); 
            ui.appendChild(backBtn);

            tracks.forEach(track => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-[#1DB954]/10 border border-[#1DB954]/30 rounded-lg mb-2 cursor-pointer hover:bg-[#1DB954]/20 transition-all';
                div.innerHTML = `
                    <div class="truncate mr-2">
                        <div class="text-xs font-bold text-white truncate">${track.name}</div>
                        <div class="text-[10px] text-zinc-400 truncate">${track.album.name} (${track.album.release_date.split('-')[0]})</div>
                    </div>
                    <div class="text-[#1DB954] font-bold text-lg">+</div>
                `;
                div.onclick = () => {
                    addSong(track.name, track.album.name);
                    saveToCloud(track.name, track.album.name); 
                };
                ui.appendChild(div);
            });
        }

        let useWhiteTags = false;
        let bgStyle = { scale: 100, x: 50, y: 50 };
        
        const posterContainer = document.getElementById('playlist-items');
        Sortable.create(posterContainer, { 
            animation: 200, 
            ghostClass: 'ghost', 
            onEnd: () => syncOrderFromPoster() 
        });

        const playlistUI = document.getElementById('playlist-list-ui');

        window.switchTab = (tab) => {
            document.getElementById('panel-edit').classList.toggle('hidden', tab !== 'edit');
            document.getElementById('panel-library').classList.toggle('hidden', tab !== 'library');
            document.getElementById('tab-edit').className = `tab-btn pb-3 transition-all ${tab === 'edit' ? 'active text-white' : 'text-zinc-500'}`;
            document.getElementById('tab-library').className = `tab-btn pb-3 transition-all ${tab === 'library' ? 'active text-white' : 'text-zinc-500'}`;
        };
        window.toggleBulkModal = () => document.getElementById('bulk-modal').classList.toggle('hidden');

        function updateBgStyle() {
            const zone = document.getElementById('capture-zone');
            zone.style.backgroundSize = `${bgStyle.scale}%`;
            zone.style.backgroundPosition = `${bgStyle.x}% ${bgStyle.y}%`;
            document.getElementById('val-scale').innerText = `${bgStyle.scale}%`;
            document.getElementById('val-x').innerText = `${bgStyle.x}%`;
            document.getElementById('val-y').innerText = `${bgStyle.y}%`;
        }

        window.addSong = (name, album) => {
            const id = 'song-' + Date.now() + Math.random().toString(36).substr(2, 5);
            const tag = document.createElement('div');
            tag.className = `song-tag ${useWhiteTags ? 'tag-white' : ''}`;
            tag.setAttribute('data-id', id);
            tag.setAttribute('data-name', name);
            tag.setAttribute('data-album', album || '');
            posterContainer.appendChild(tag);
            updateIndices(); 
            if (document.getElementById('spotify-query').value === '') {
                syncOrderFromPoster();
            }
        };

        window.deleteSong = (id) => {
            const tag = posterContainer.querySelector(`[data-id="${id}"]`);
            if (tag) tag.remove();
            updateIndices();
            syncOrderFromPoster();
        };

        function syncOrderFromPoster() {
            updateIndices();
            const newOrderIds = Array.from(posterContainer.children).map(el => el.getAttribute('data-id'));
            playlistUI.innerHTML = '';
            Array.from(posterContainer.children).forEach(tag => {
                const id = tag.getAttribute('data-id');
                const name = tag.getAttribute('data-name');
                const album = tag.getAttribute('data-album');
                const li = document.createElement('div');
                li.className = 'list-item flex justify-between items-center p-3 bg-zinc-800 rounded-xl border border-zinc-700/50 text-xs hover:border-zinc-500 transition-all shadow-sm mb-2';
                li.innerHTML = `
                    <div class="flex flex-col truncate mr-2">
                        <div class="font-bold text-zinc-100 truncate">${name}</div>
                        <div class="text-[10px] text-zinc-500 truncate">${album || 'å–®æ›²/æœªçŸ¥å°ˆè¼¯'}</div>
                    </div>
                    <button class="text-zinc-500 hover:text-red-400 p-1 transition-all flex-shrink-0" onclick="deleteSong('${id}')">âœ•</button>
                `;
                playlistUI.appendChild(li);
            });
        }

        function updateIndices() {
            let scale = 1.0;
            document.documentElement.style.setProperty('--tag-scale', scale);
            const titleH = document.getElementById('title-container').offsetHeight;
            const contentPadding = 48; 
            const totalH = 400; 
            const availableH = totalH - contentPadding - titleH - 10; 
            posterContainer.style.height = `${availableH}px`;

            const items = Array.from(posterContainer.children);
            items.forEach((tag, i) => {
                const name = tag.getAttribute('data-name');
                const album = tag.getAttribute('data-album');
                tag.className = `song-tag ${useWhiteTags ? 'tag-white' : ''}`;
                tag.innerHTML = `<div class="tag-inner"><span class="tag-index">${i + 1}.</span><div class="tag-content"><span class="tag-name">${name}</span>${album ? `<span class="tag-album">(from ${album})</span>` : ''}</div></div>`;
            });

            setTimeout(() => checkOverflowAndShrink(availableH, 1.0), 0);
        }

        function checkOverflowAndShrink(availableHeight, currentScale) {
            if (currentScale < 0.4) return; 
            const containerRect = document.querySelector('.content-layer').getBoundingClientRect();
            const limitLeft = containerRect.left + 24; 
            let minLeft = Infinity;
            Array.from(posterContainer.children).forEach(tag => {
                const r = tag.getBoundingClientRect();
                if (r.left < minLeft) minLeft = r.left;
            });
            if (minLeft < limitLeft) {
                const nextScale = currentScale - 0.05;
                document.documentElement.style.setProperty('--tag-scale', nextScale);
                setTimeout(() => checkOverflowAndShrink(availableHeight, nextScale), 0);
            }
        }

        document.getElementById('nickname-input').addEventListener('input', (e) => {
            const lines = e.target.value.split('\n');
            document.getElementById('title-container').innerHTML = `<div class="title-main">${lines[0] || ''}</div><div class="title-sub">${lines[1] || ''}</div>`;
            updateIndices(); 
        });

        async function saveToCloud(name, album) {
            if (!db || !user) return;
            const id = btoa(encodeURIComponent(name + album)).substring(0, 24);
            try {
                const songDoc = doc(db, 'artifacts', appId, 'public', 'data', 'song_library', id);
                await setDoc(songDoc, { name, album: album || '', time: serverTimestamp() }, { merge: true });
            } catch (e) {}
        }

        function listenToLibrary() {
            if (!db) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'song_library'), (snap) => {
                allLibrarySongs = snap.docs.map(doc => doc.data()).sort((a, b) => {
                    const albumA = (a.album || "").toString();
                    const albumB = (b.album || "").toString();
                    const albumCompare = albumA.localeCompare(albumB, "zh-Hant");
                    if (albumCompare !== 0) return albumCompare;
                    return (a.name || "").localeCompare(b.name || "", "zh-Hant");
                });
                renderLibrary();
            });
        }

        function renderLibrary(filter = '') {
            const libUI = document.getElementById('library-list-ui');
            libUI.innerHTML = '';
            const filtered = allLibrarySongs.filter(s => s.name.toLowerCase().includes(filter) || (s.album && s.album.toLowerCase().includes(filter)));
            if (filtered.length === 0) { libUI.innerHTML = '<div class="text-center text-zinc-500 py-10 text-xs">æ‰¾ä¸åˆ°ç¬¦åˆçš„æ­Œæ›²</div>'; return; }
            filtered.forEach(d => {
                const btn = document.createElement('div');
                btn.className = 'p-3 bg-zinc-800/50 rounded-xl cursor-pointer hover:bg-zinc-700 border border-transparent hover:border-zinc-600 transition-all text-xs flex justify-between items-center group';
                btn.innerHTML = `<div><div class="font-bold">${d.name}</div><div class="text-[10px] text-zinc-500">${d.album}</div></div><span class="text-green-500 font-bold opacity-0 group-hover:opacity-100">+</span>`;
                btn.onclick = () => { addSong(d.name, d.album); saveToCloud(d.name, d.album); };
                libUI.appendChild(btn);
            });
        }

        document.getElementById('library-search').oninput = (e) => renderLibrary(e.target.value.toLowerCase());
        
        document.getElementById('add-custom-btn').onclick = () => {
            const name = document.getElementById('custom-name').value;
            const album = document.getElementById('custom-album').value;
            if (!name) return;
            addSong(name, album);
            saveToCloud(name, album);
            document.getElementById('custom-name').value = '';
            document.getElementById('custom-album').value = '';
        };

        document.getElementById('bulk-import-btn').onclick = async () => {
            const text = document.getElementById('bulk-input').value;
            const lines = text.split('\n');
            for(const line of lines) {
                const [n, a] = line.split(/[,\t]/);
                if (n && n.trim()) { addSong(n.trim(), a ? a.trim() : ''); saveToCloud(n.trim(), a ? a.trim() : ''); }
            }
            document.getElementById('bulk-input').value = '';
            toggleBulkModal();
        };

        document.getElementById('clear-all-btn').onclick = () => {
            if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ­Œå–®å—ï¼Ÿ')) { posterContainer.innerHTML = ''; playlistUI.innerHTML = ''; updateIndices(); }
        };

        document.getElementById('bg-upload').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const zone = document.getElementById('capture-zone');
                    zone.style.backgroundImage = `url(${ev.target.result})`;
                    zone.style.color = 'white';
                    updateBgStyle();
                };
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('bg-scale').oninput = (e) => { bgStyle.scale = e.target.value; updateBgStyle(); };
        document.getElementById('bg-x').oninput = (e) => { bgStyle.x = e.target.value; updateBgStyle(); };
        document.getElementById('bg-y').oninput = (e) => { bgStyle.y = e.target.value; updateBgStyle(); };
        document.getElementById('toggle-color').onclick = () => { document.getElementById('capture-zone').style.color = document.getElementById('capture-zone').style.color === 'white' ? 'black' : 'white'; };
        document.getElementById('toggle-tag-color').onclick = () => { useWhiteTags = !useWhiteTags; updateIndices(); };

        document.getElementById('export-btn').onclick = async () => {
            const btn = document.getElementById('export-btn');
            const originalText = btn.innerText;
            btn.innerText = 'è™•ç†ä¸­...';
            const poster = document.getElementById('capture-zone');
            const oldT = poster.style.transform;
            poster.style.transform = 'scale(1)';
            const canvas = await html2canvas(poster, { scale: 3, useCORS: true, width: 592, height: 400, logging: false });
            poster.style.transform = oldT;
            const link = document.createElement('a');
            link.download = 'My_Setlist.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.innerText = originalText;
        };

        function autoScale() {
            const wrap = document.getElementById('scale-wrapper');
            const poster = document.getElementById('capture-zone');
            const s = Math.min(1, (wrap.clientWidth - 40) / 592);
            poster.style.transform = `scale(${s})`;
            wrap.style.height = (400 * s + 20) + 'px';
        }
        window.onresize = autoScale;
        window.onload = autoScale;
    </script>
</body>
</html>