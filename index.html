<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­Œå–®æµ·å ±ç”¢ç”Ÿå™¨ (Firebase æ¬Šé™ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root { --tag-scale: 1; }
        body { font-family: 'Noto Sans JP', 'Noto Sans TC', sans-serif; overflow: hidden; background-color: #18181b; }
        .ghost { opacity: 0.2; background: #3f3f46 !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .poster-size {
            width: 592px; height: 400px; position: relative; overflow: hidden;
            flex-shrink: 0; background-color: #2d5a3a; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .song-tag {
            background-color: rgba(0, 0, 0, 0.6); color: white;
            padding: calc(6px * var(--tag-scale)) calc(12px * var(--tag-scale)); 
            display: inline-block; transform: skewX(-5deg);
            margin-bottom: calc(3px * var(--tag-scale)); margin-left: calc(10px * var(--tag-scale));  
            border-right: calc(2px * var(--tag-scale)) solid rgba(255, 255, 255, 0.2);
            border-bottom: calc(2px * var(--tag-scale)) solid rgba(255, 255, 255, 0.2);
            text-align: left; min-width: fit-content; max-width: 90%; 
        }
        .song-tag.tag-white {
            background-color: rgba(255, 255, 255, 0.6); color: black;
            border-right: calc(2px * var(--tag-scale)) solid rgba(0, 0, 0, 0.3);
            border-bottom: calc(2px * var(--tag-scale)) solid rgba(0, 0, 0, 0.3);
        }
        .song-tag > .tag-inner { transform: skewX(5deg); display: flex; align-items: baseline; gap: calc(8px * var(--tag-scale)); }
        .tag-index { font-size: calc(13px * var(--tag-scale)); font-weight: 900; line-height: 1; flex-shrink: 0; min-width: calc(18px * var(--tag-scale)); text-align: right; font-style: italic; }
        .tag-name { font-size: calc(13px * var(--tag-scale)); font-weight: 900; line-height: 1; letter-spacing: 0.02em; white-space: nowrap; }
        .tag-album { font-size: calc(9px * var(--tag-scale)); font-weight: 400; opacity: 0.8; line-height: 1.2; margin-top: calc(3px * var(--tag-scale)); white-space: nowrap; }
        
        .content-layer { position: relative; z-index: 10; height: 100%; display: flex; flex-direction: column; padding: 24px; box-sizing: border-box; }
        .title-main { font-size: 1.8rem; font-weight: 900; line-height: 1.1; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .title-sub { font-size: 1rem; opacity: 0.8; padding-left: 1em; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        
        #playlist-items { display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-end; justify-content: flex-end; width: 100%; overflow: visible; }
        #capture-zone { background-repeat: no-repeat; background-size: cover; background-position: center; transform-origin: top center; }
        
        .tab-btn.active { border-bottom: 2px solid #22c55e; color: white; }
    </style>
</head>
<body class="text-zinc-100 h-[100dvh] flex flex-col">

    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        <!-- å·¦å´ï¼šé è¦½ -->
        <div class="flex-1 p-4 flex flex-col items-center bg-zinc-800 relative overflow-y-auto">
            <div id="scale-wrapper" class="w-full flex justify-center items-start pt-4 transition-all duration-300">
                <div id="capture-zone" class="poster-size shadow-2xl">
                    <div class="content-layer">
                        <div id="title-container" class="mb-3 flex-shrink-0">
                            <div class="title-main">è«‹åœ¨æ­¤è¼¸å…¥æ­Œå–®æ¨™é¡Œ</div>
                            <div class="title-sub">æ›è¡Œä»¥è¼¸å…¥å‰¯æ¨™é¡Œ</div>
                        </div>
                        <div id="playlist-items"></div>
                    </div>
                </div>
            </div>

            <div class="mt-6 w-full max-w-3xl bg-zinc-700/50 p-5 rounded-2xl border border-zinc-600 backdrop-blur-sm shadow-xl">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-3">
                        <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">æ¨™é¡Œæ–‡å­—</p>
                        <textarea id="nickname-input" rows="2" class="w-full bg-zinc-900/80 p-3 rounded-lg text-xs outline-none focus:ring-1 focus:ring-green-500 transition-all font-mono" placeholder="æ¨™é¡Œ&#10;å‰¯æ¨™é¡Œ">è«‹åœ¨æ­¤è¼¸å…¥æ­Œå–®æ¨™é¡Œ&#10;æ›è¡Œä»¥è¼¸å…¥å‰¯æ¨™é¡Œ</textarea>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="toggle-color" class="bg-zinc-600 hover:bg-zinc-500 py-2 rounded text-[10px]">æ–‡å­—é»‘/ç™½</button>
                            <button id="toggle-tag-color" class="bg-zinc-600 hover:bg-zinc-500 py-2 rounded text-[10px]">æ¨™ç±¤é»‘/ç™½</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">åº•åœ–èª¿æ•´</p>
                        <div class="space-y-3 pt-1">
                            <div class="flex flex-col gap-1"><div class="flex justify-between text-[9px] text-zinc-400"><span>ç¸®æ”¾</span><span id="val-scale">100%</span></div><input type="range" id="bg-scale" min="100" max="300" value="100"></div>
                            <div class="flex flex-col gap-1"><div class="flex justify-between text-[9px] text-zinc-400"><span>æ°´å¹³</span><span id="val-x">50%</span></div><input type="range" id="bg-x" min="0" max="100" value="50"></div>
                            <div class="flex flex-col gap-1"><div class="flex justify-between text-[9px] text-zinc-400"><span>å‚ç›´</span><span id="val-y">50%</span></div><input type="range" id="bg-y" min="0" max="100" value="50"></div>
                        </div>
                    </div>
                    <div class="flex flex-col justify-between space-y-3">
                        <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">è¼¸å‡º</p>
                        <div class="flex-1 flex flex-col gap-2">
                            <label class="flex items-center justify-center gap-2 w-full bg-zinc-100 text-zinc-900 py-3 rounded-xl text-xs font-bold cursor-pointer hover:bg-white shadow-lg"><span>ğŸ“· ä¸Šå‚³åº•åœ–</span><input type="file" id="bg-upload" accept="image/*" class="hidden"></label>
                            <button id="export-btn" class="w-full bg-green-600 text-white font-black py-4 rounded-xl text-xs shadow-lg hover:bg-green-500 uppercase">â¬‡ åŒ¯å‡ºåœ–ç‰‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šç·¨è¼¯ -->
        <div class="w-full lg:w-[380px] h-[55vh] lg:h-auto bg-zinc-900 border-l border-zinc-800 p-5 flex flex-col">
            <div class="flex gap-6 border-b border-zinc-800 mb-5 text-sm font-bold">
                <button id="tab-edit" class="tab-btn pb-3 active" onclick="switchTab('edit')">ç›®å‰æ­Œå–®</button>
                <button id="tab-library" class="tab-btn pb-3 text-zinc-500" onclick="switchTab('library')">ç¤¾ç¾¤æ­Œåº«</button>
            </div>
            
            <div id="panel-edit" class="flex flex-col flex-1 overflow-hidden">
                <div class="mb-4 space-y-2">
                    <div id="spotify-login-area">
                        <button id="login-spotify-btn" class="w-full bg-[#1DB954] hover:bg-[#1ed760] text-black font-bold py-2.5 rounded-lg text-xs flex items-center justify-center gap-2">
                            <span>ç™»å…¥ Spotify æœå°‹æ­Œæ›²</span>
                        </button>
                    </div>
                    <div id="spotify-search-area" class="hidden flex flex-col gap-2">
                        <div class="flex gap-2">
                            <input type="text" id="spotify-query" placeholder="æœå°‹æ­Œæ›²..." class="flex-1 bg-zinc-800 p-2.5 rounded-lg text-xs border border-zinc-700 outline-none focus:border-[#1DB954]">
                            <button id="search-spotify-btn" class="bg-zinc-700 hover:bg-zinc-600 text-white px-4 rounded-lg text-xs">æœå°‹</button>
                        </div>
                        <div id="spotify-results" class="hidden max-h-48 overflow-y-auto bg-zinc-800/50 rounded-lg border border-zinc-700 p-1 no-scrollbar"></div>
                    </div>
                </div>
                <div id="playlist-list-ui" class="flex-1 overflow-y-auto space-y-2 no-scrollbar pr-1"></div>
                <div class="flex justify-between items-center mt-4 border-t border-zinc-800 pt-3">
                    <button onclick="toggleBulkModal()" class="text-[11px] text-zinc-400 hover:text-white underline">æ‰¹æ¬¡åŒ¯å…¥</button>
                    <button id="clear-all-btn" class="text-[11px] text-red-500 hover:text-red-400 font-bold">æ¸…ç©ºå…¨éƒ¨</button>
                </div>
            </div>

            <div id="panel-library" class="hidden flex-1 flex flex-col overflow-hidden">
                <div id="library-status" class="text-[10px] text-zinc-500 mb-2">æ­£åœ¨é€£æ¥ç¤¾ç¾¤æ­Œåº«...</div>
                <div id="library-list-ui" class="flex-1 overflow-y-auto space-y-2 no-scrollbar"></div>
            </div>
        </div>
    </div>

    <!-- æ‰¹æ¬¡åŒ¯å…¥ Modal -->
    <div id="bulk-modal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
        <div class="bg-zinc-800 p-8 rounded-2xl w-full max-w-md border border-zinc-700 shadow-2xl">
            <h3 class="font-bold text-lg mb-2">æ‰¹æ¬¡åŒ¯å…¥</h3>
            <p class="text-[10px] text-zinc-500 mb-4">æ ¼å¼ï¼šæ­Œå,å°ˆè¼¯ (ä¸€è¡Œä¸€é¦–)</p>
            <textarea id="bulk-input" rows="8" class="w-full bg-zinc-900 p-4 rounded-xl text-xs mb-6 outline-none" placeholder="æ­Œå1,å°ˆè¼¯1&#10;æ­Œå2,å°ˆè¼¯2"></textarea>
            <div class="flex gap-3">
                <button onclick="toggleBulkModal()" class="flex-1 bg-zinc-700 py-3 rounded-xl text-xs font-bold">å–æ¶ˆ</button>
                <button id="bulk-import-btn" class="flex-1 bg-green-600 py-3 rounded-xl text-xs font-bold">é–‹å§‹åŒ¯å…¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, serverTimestamp, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // Firebase æ‰‹å‹•è¨­å®šå€
        // ==========================================
        const manualFirebaseConfig = {
            apiKey: "AIzaSyDhP9JryXni2a6SOka73Lgng80DBwg0esI",
  authDomain: "my-setlist-25d7a.firebaseapp.com",
  projectId: "my-setlist-25d7a",
  storageBucket: "my-setlist-25d7a.firebasestorage.app",
  messagingSenderId: "723230839513",
  appId: "1:723230839513:web:307d5221fada859e6f24c8"
        };
        // ==========================================

        const spotifyClientId = "1ed974a9278b46a0af69f3e112977dc8"; 
        const redirectUri = window.location.origin + window.location.pathname;
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-setlist-app';
        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const finalConfig = (envFirebaseConfig && envFirebaseConfig.apiKey) ? envFirebaseConfig : manualFirebaseConfig;

        let db = null, auth = null, user = null;
        let spotifyToken = localStorage.getItem('spotify_access_token');

        // åˆå§‹åŒ– Firebase
        if (finalConfig.apiKey) {
            const app = initializeApp(finalConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // åš´æ ¼éµå®ˆ RULE 3: å…ˆç™»å…¥ï¼Œå†æ“ä½œ Firestore
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Authentication failed:", e);
                    document.getElementById('library-status').innerText = "é©—è­‰å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase è¨­å®šã€‚";
                }
            };

            onAuthStateChanged(auth, u => { 
                user = u; 
                if (user) {
                    document.getElementById('library-status').innerText = "ç¤¾ç¾¤æ­Œåº«å·²é€£ç·š";
                    listenToLibrary(); 
                }
            });

            initAuth();
        } else {
            document.getElementById('library-status').innerText = "æœªè¨­å®š Firebase API Key";
        }

        // ç²å–ç¤¾ç¾¤æ­Œåº« (éµå®ˆ RULE 1 & 2)
        function listenToLibrary() {
            if (!db || !user) return;
            // åš´æ ¼éµå®ˆè·¯å¾‘æ ¼å¼: /artifacts/{appId}/public/data/{collection}
            const libCollection = collection(db, 'artifacts', envAppId, 'public', 'data', 'song_library');
            const q = query(libCollection, limit(50));
            
            onSnapshot(q, (snapshot) => {
                const listUI = document.getElementById('library-list-ui');
                listUI.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2.5 bg-zinc-800 rounded-lg border border-zinc-700/50 text-[11px] cursor-pointer hover:bg-zinc-700 transition-colors';
                    div.innerHTML = `
                        <div class="truncate">
                            <div class="font-bold text-white">${data.name}</div>
                            <div class="text-zinc-500 text-[9px]">${data.album || 'æœªçŸ¥å°ˆè¼¯'}</div>
                        </div>
                        <span class="text-green-500 font-bold text-lg">+</span>`;
                    div.onclick = () => addSong(data.name, data.album);
                    listUI.appendChild(div);
                });
            }, (err) => {
                console.error("Library snapshot error:", err);
                document.getElementById('library-status').innerText = "æ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥ Firebase Rules è¨­å®šã€‚";
            });
        }

        // å„²å­˜è‡³é›²ç«¯ (éµå®ˆè·¯å¾‘æ ¼å¼)
        async function saveToCloud(name, album) {
            if (!db || !user) return;
            try {
                const docId = btoa(encodeURIComponent(name + (album || ""))).substring(0, 28);
                const docRef = doc(db, 'artifacts', envAppId, 'public', 'data', 'song_library', docId);
                await setDoc(docRef, { 
                    name, 
                    album: album || '', 
                    addedBy: user.uid,
                    time: serverTimestamp() 
                }, { merge: true });
            } catch (e) {
                console.warn("Cloud save failed (likely permissions):", e);
            }
        }

        // UI & é‚è¼¯
        const posterContainer = document.getElementById('playlist-items');
        let useWhiteTags = false;
        Sortable.create(posterContainer, { animation: 200, onEnd: () => syncOrder() });

        window.addSong = (name, album) => {
            const id = 's-' + Date.now() + Math.random().toString(36).substr(2, 4);
            const tag = document.createElement('div');
            tag.className = `song-tag ${useWhiteTags ? 'tag-white' : ''}`;
            tag.setAttribute('data-id', id);
            tag.setAttribute('data-name', name);
            tag.setAttribute('data-album', album || '');
            posterContainer.appendChild(tag);
            syncOrder();
        };

        window.deleteSong = (id) => {
            const el = posterContainer.querySelector(`[data-id="${id}"]`);
            if (el) el.remove();
            syncOrder();
        };

        function syncOrder() {
            const tags = Array.from(posterContainer.children);
            const listUI = document.getElementById('playlist-list-ui');
            listUI.innerHTML = '';
            tags.forEach((tag, i) => {
                const id = tag.getAttribute('data-id');
                const name = tag.getAttribute('data-name');
                const album = tag.getAttribute('data-album');
                tag.innerHTML = `<div class="tag-inner"><span class="tag-index">${i+1}.</span><div class="tag-content"><span class="tag-name">${name}</span>${album ? `<span class="tag-album">(from ${album})</span>` : ''}</div></div>`;
                const li = document.createElement('div');
                li.className = 'flex justify-between items-center p-2 bg-zinc-800 rounded text-[11px] mb-2 border border-zinc-700/30';
                li.innerHTML = `<div class="truncate"><b>${i+1}.</b> ${name}</div><button onclick="deleteSong('${id}')" class="text-zinc-500 hover:text-red-400 px-2">âœ•</button>`;
                listUI.appendChild(li);
            });
            autoScale();
        }

        async function searchSpotify() {
            const q = document.getElementById('spotify-query').value.trim();
            if (!q || !spotifyToken) return;
            try {
                const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&limit=10`, {
                    headers: { 'Authorization': 'Bearer ' + spotifyToken }
                });
                if (res.status === 401) { alert("Spotify é©—è­‰éæœŸï¼Œè«‹é‡æ–°ç™»å…¥"); return; }
                const data = await res.json();
                const resultsUI = document.getElementById('spotify-results');
                resultsUI.innerHTML = '';
                resultsUI.classList.remove('hidden');
                data.tracks.items.forEach(track => {
                    const div = document.createElement('div');
                    div.className = 'p-2 hover:bg-zinc-700 cursor-pointer text-[10px] border-b border-zinc-700 last:border-0 flex justify-between';
                    div.innerHTML = `<div><div class="font-bold text-white">${track.name}</div><div class="text-zinc-400">${track.artists[0].name}</div></div><span class="text-green-500">+</span>`;
                    div.onclick = () => { addSong(track.name, track.album.name); saveToCloud(track.name, track.album.name); };
                    resultsUI.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }

        // åº•åœ–èˆ‡åŒ¯å‡º
        document.getElementById('bg-scale').oninput = (e) => { updateBg('scale', e.target.value); };
        document.getElementById('bg-x').oninput = (e) => { updateBg('x', e.target.value); };
        document.getElementById('bg-y').oninput = (e) => { updateBg('y', e.target.value); };
        function updateBg(type, val) {
            const z = document.getElementById('capture-zone');
            if(type==='scale') z.style.backgroundSize = val + '%';
            if(type==='x' || type==='y') {
                const x = document.getElementById('bg-x').value;
                const y = document.getElementById('bg-y').value;
                z.style.backgroundPosition = `${x}% ${y}%`;
            }
            document.getElementById('val-'+type).innerText = val + '%';
        }

        document.getElementById('nickname-input').oninput = (e) => {
            const lines = e.target.value.split('\n');
            document.getElementById('title-container').innerHTML = `<div class="title-main">${lines[0] || ''}</div><div class="title-sub">${lines[1] || ''}</div>`;
        };

        document.getElementById('bg-upload').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => { document.getElementById('capture-zone').style.backgroundImage = `url(${ev.target.result})`; };
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('toggle-color').onclick = () => {
            const z = document.getElementById('capture-zone');
            z.style.color = z.style.color === 'black' ? 'white' : 'black';
        };

        document.getElementById('search-spotify-btn').onclick = searchSpotify;
        document.getElementById('clear-all-btn').onclick = () => { posterContainer.innerHTML = ''; syncOrder(); };
        document.getElementById('toggle-tag-color').onclick = () => { useWhiteTags = !useWhiteTags; syncOrder(); };
        document.getElementById('export-btn').onclick = async () => {
            const canvas = await html2canvas(document.getElementById('capture-zone'), { scale: 3, useCORS: true });
            const a = document.createElement('a'); a.download = 'setlist.png'; a.href = canvas.toDataURL(); a.click();
        };

        window.switchTab = (tab) => {
            const isEdit = tab === 'edit';
            document.getElementById('panel-edit').classList.toggle('hidden', !isEdit);
            document.getElementById('panel-library').classList.toggle('hidden', isEdit);
            document.getElementById('tab-edit').classList.toggle('active', isEdit);
            document.getElementById('tab-library').classList.toggle('active', !isEdit);
        };

        window.toggleBulkModal = () => document.getElementById('bulk-modal').classList.toggle('hidden');
        document.getElementById('bulk-import-btn').onclick = () => {
            document.getElementById('bulk-input').value.split('\n').forEach(l => {
                const p = l.split(','); if(p[0]) addSong(p[0].trim(), (p[1]||'').trim());
            });
            toggleBulkModal();
        };

        const autoScale = () => {
            const w = document.getElementById('scale-wrapper');
            const s = Math.min(1, (w.clientWidth - 40) / 592);
            document.getElementById('capture-zone').style.transform = `scale(${s})`;
            w.style.height = (400 * s + 20) + 'px';
        };
        window.onresize = autoScale; autoScale();
    </script>
</body>
</html>