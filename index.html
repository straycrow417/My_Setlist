<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­Œå–®æµ·å ±ç”¢ç”Ÿå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { --tag-scale: 1; }
        body { font-family: 'Noto Sans TC', sans-serif; overflow: hidden; background-color: #18181b; }
        .ghost { opacity: 0.2; background: #3f3f46 !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .poster-size {
            width: 592px; height: 400px; position: relative; overflow: hidden;
            flex-shrink: 0; background-color: #2d5a3a; transform-origin: top center;
        }
        .song-tag {
            background-color: rgba(0, 0, 0, 0.6); color: white;
            padding: calc(6px * var(--tag-scale)) calc(12px * var(--tag-scale)); 
            display: inline-block; transform: skewX(-5deg);
            margin-bottom: calc(6px * var(--tag-scale)); margin-left: calc(10px * var(--tag-scale));  
            border-right: calc(2px * var(--tag-scale)) solid rgba(255, 255, 255, 0.2);
            border-bottom: calc(2px * var(--tag-scale)) solid rgba(255, 255, 255, 0.2);
            text-align: left; min-width: fit-content; max-width: 90%; 
        }
        .song-tag.tag-white {
            background-color: rgba(255, 255, 255, 0.6); color: black;
            border-right: calc(2px * var(--tag-scale)) solid rgba(0, 0, 0, 0.3);
            border-bottom: calc(2px * var(--tag-scale)) solid rgba(0, 0, 0, 0.3);
        }
        .song-tag > .tag-inner { transform: skewX(5deg); display: flex; align-items: baseline; gap: calc(8px * var(--tag-scale)); }
        .tag-index { font-size: calc(13px * var(--tag-scale)); font-weight: 900; font-style: italic; }
        .tag-name { font-size: calc(13px * var(--tag-scale)); font-weight: 900; white-space: nowrap; }
        .tag-album { font-size: calc(9px * var(--tag-scale)); opacity: 0.8; margin-top: calc(3px * var(--tag-scale)); white-space: nowrap; }
        .content-layer { position: relative; z-index: 10; height: 100%; display: flex; flex-direction: column; padding: 24px; }
        .title-main { font-size: 1.8rem; font-weight: 900; line-height: 1.1; }
        .title-sub { font-size: 1rem; opacity: 0.8; padding-left: 1em; }
        #playlist-items { display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-end; justify-content: flex-end; height: 310px; width: 100%; }
        .tab-btn.active { border-bottom: 2px solid #22c55e; color: white; }
        input[type=range] { accent-color: #22c55e; }
        .sortable-item { cursor: grab; }
    </style>
</head>
<body class="text-zinc-100 h-[100dvh] flex flex-col">

    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        <!-- å·¦å´é è¦½å€ -->
        <div class="flex-1 p-4 flex flex-col items-center bg-zinc-800 relative overflow-y-auto">
            <div id="scale-wrapper" class="w-full flex justify-center items-start pt-4">
                <div id="capture-zone" class="poster-size shadow-2xl">
                    <div class="content-layer">
                        <div id="title-container" class="mb-3">
                            <div class="title-main">æ­Œå–®æ¨™é¡Œ</div>
                            <div class="title-sub">å‰¯æ¨™é¡Œ</div>
                        </div>
                        <div id="playlist-items"></div>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="mt-4 w-full max-w-2xl bg-zinc-700 p-4 rounded-xl border border-zinc-600">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <p class="text-[10px] text-zinc-400 font-bold uppercase">æ¨™é¡Œè¨­å®š</p>
                        <textarea id="nickname-input" rows="2" class="w-full bg-zinc-800 p-2 rounded text-xs outline-none">æ­Œå–®æ¨™é¡Œ&#10;å‰¯æ¨™é¡Œ</textarea>
                    </div>
                    <div class="flex flex-col gap-2">
                        <p class="text-[10px] text-zinc-400 font-bold uppercase">å¤–è§€æ“ä½œ</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="toggle-color" class="bg-zinc-600 py-1 rounded text-[10px]">åˆ‡æ›æ¨™é¡Œé»‘ç™½</button>
                            <button id="toggle-tag-color" class="bg-zinc-600 py-1 rounded text-[10px]">åˆ‡æ›æ¨™ç±¤é»‘ç™½</button>
                        </div>
                        <div class="flex gap-2">
                            <label class="flex-1 bg-zinc-600 text-center py-2 rounded text-[10px] cursor-pointer">ğŸ“· ä¸Šå‚³åº•åœ–<input type="file" id="bg-upload" accept="image/*" class="hidden"></label>
                            <button id="export-btn" class="flex-1 bg-green-600 text-white font-bold rounded text-[10px]">â¬‡ åŒ¯å‡ºåœ–ç‰‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´æ¸…å–®å€ -->
        <div class="w-full lg:w-[360px] h-[40vh] lg:h-auto bg-zinc-900 border-l border-zinc-800 p-4 flex flex-col">
            <div class="flex gap-4 border-b border-zinc-800 mb-4 text-xs">
                <button id="tab-edit" class="tab-btn pb-2 active" onclick="switchTab('edit')">ç·¨è¼¯æ­Œå–®</button>
                <button id="tab-library" class="tab-btn pb-2" onclick="switchTab('library')">ç¤¾ç¾¤æ­Œåº«</button>
            </div>
            
            <div id="panel-edit" class="flex flex-col flex-1 overflow-hidden">
                <div class="space-y-2 mb-4">
                    <input type="text" id="custom-name" placeholder="æ­Œå" class="w-full bg-zinc-800 p-2 rounded text-xs">
                    <input type="text" id="custom-album" placeholder="å°ˆè¼¯" class="w-full bg-zinc-800 p-2 rounded text-xs">
                    <button id="add-custom-btn" class="w-full bg-green-600 py-2 rounded text-xs font-bold">+ åŠ å…¥</button>
                </div>
                <div id="playlist-list-ui" class="flex-1 overflow-y-auto space-y-2 no-scrollbar"></div>
                <button onclick="toggleBulkModal()" class="mt-2 text-[10px] text-zinc-500 underline text-center">æ‰¹æ¬¡æ–‡å­—åŒ¯å…¥</button>
            </div>

            <div id="panel-library" class="hidden flex-1 flex flex-col overflow-hidden">
                <input type="text" id="library-search" placeholder="æœå°‹æ­Œåº«..." class="w-full bg-zinc-800 p-2 rounded text-xs mb-2">
                <div id="library-list-ui" class="flex-1 overflow-y-auto space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- æ‰¹æ¬¡åŒ¯å…¥å½ˆçª— -->
    <div id="bulk-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-zinc-800 p-6 rounded-xl w-full max-w-sm">
            <h3 class="font-bold mb-4">æ‰¹æ¬¡åŒ¯å…¥ (æ­Œå,å°ˆè¼¯)</h3>
            <textarea id="bulk-input" rows="6" class="w-full bg-zinc-900 p-3 rounded text-xs mb-4" placeholder="æ­Œæ›²A,å°ˆè¼¯A&#10;æ­Œæ›²B,å°ˆè¼¯B"></textarea>
            <div class="flex gap-2">
                <button onclick="toggleBulkModal()" class="flex-1 bg-zinc-700 py-2 rounded text-xs">å–æ¶ˆ</button>
                <button id="bulk-import-btn" class="flex-1 bg-green-600 py-2 rounded text-xs font-bold">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === è«‹åœ¨æ­¤å¡«å…¥ Firebase é…ç½® ===
        const manualConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : manualConfig;
        let db = null;
        let auth = null;
        let user = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-poster-app';

        // åˆå§‹åŒ– Firebase
        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // å¼·åˆ¶å…ˆåŸ·è¡Œé©—è­‰ï¼ŒæˆåŠŸå¾Œå†ç›£è½è³‡æ–™
                const startAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("é©—è­‰å¤±æ•—:", err);
                    }
                };

                onAuthStateChanged(auth, (u) => { 
                    user = u; 
                    if (user) {
                        console.log("ç™»å…¥æˆåŠŸ:", user.uid);
                        listenToLibrary();
                    }
                });

                startAuth();
            } catch (e) { console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e); }
        } else {
            console.warn("Firebase Config æœªè¨­å®šï¼Œåƒ…èƒ½ä½¿ç”¨æœ¬åœ°åŠŸèƒ½ã€‚");
        }

        let useWhiteTags = false;
        const playlistUI = document.getElementById('playlist-list-ui');
        Sortable.create(playlistUI, { animation: 150, onEnd: () => syncPoster() });

        window.switchTab = (tab) => {
            document.getElementById('panel-edit').classList.toggle('hidden', tab !== 'edit');
            document.getElementById('panel-library').classList.toggle('hidden', tab !== 'library');
            document.getElementById('tab-edit').classList.toggle('active', tab === 'edit');
            document.getElementById('tab-library').classList.toggle('active', tab === 'library');
        };

        window.toggleBulkModal = () => document.getElementById('bulk-modal').classList.toggle('hidden');

        window.createItemUI = (name, album) => {
            const div = document.createElement('div');
            div.className = 'sortable-item flex justify-between items-center p-2 bg-zinc-800 rounded border border-zinc-700 text-xs';
            div.dataset.name = name;
            div.dataset.album = album;
            div.innerHTML = `<div><div class="font-bold">${name}</div><div class="text-[10px] text-zinc-500">${album||''}</div></div><button onclick="this.parentElement.remove(); syncPoster();">âœ•</button>`;
            playlistUI.appendChild(div);
            syncPoster();
        };

        document.getElementById('add-custom-btn').onclick = () => {
            const name = document.getElementById('custom-name').value;
            const album = document.getElementById('custom-album').value;
            if(!name) return;
            createItemUI(name, album);
            saveToCloud(name, album);
            document.getElementById('custom-name').value = '';
            document.getElementById('custom-album').value = '';
        };

        document.getElementById('bulk-import-btn').onclick = () => {
            const text = document.getElementById('bulk-input').value;
            text.split('\n').forEach(line => {
                const [n, a] = line.split(',');
                if(n) { createItemUI(n.trim(), a ? a.trim() : ''); saveToCloud(n.trim(), a); }
            });
            toggleBulkModal();
        };

        async function saveToCloud(name, album) {
            if (!db || !user) return;
            // ä¿®æ­£è·¯å¾‘çµæ§‹ä»¥ç¬¦åˆæ¬Šé™
            const id = btoa(encodeURIComponent(name+album)).substring(0,20);
            try {
                const songDoc = doc(db, 'artifacts', appId, 'public', 'data', 'song_library', id);
                await setDoc(songDoc, {
                    name, album: album||'', time: serverTimestamp()
                }, {merge:true});
            } catch(e) { console.error("å„²å­˜å¤±æ•—:", e); }
        }

        function listenToLibrary() {
            if (!db || !user) return;
            const libCol = collection(db, 'artifacts', appId, 'public', 'data', 'song_library');
            onSnapshot(libCol, (snap) => {
                const libUI = document.getElementById('library-list-ui');
                libUI.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const btn = document.createElement('div');
                    btn.className = 'p-2 bg-zinc-800 rounded cursor-pointer hover:bg-zinc-700 text-xs';
                    btn.innerHTML = `<div class="font-bold">${d.name}</div><div class="text-[10px] text-zinc-500">${d.album}</div>`;
                    btn.onclick = () => createItemUI(d.name, d.album);
                    libUI.appendChild(btn);
                });
            }, (err) => {
                console.error("ç›£è½å¤±æ•— (Permission Check):", err);
            });
        }

        window.syncPoster = () => {
            const target = document.getElementById('playlist-items');
            target.innerHTML = '';
            const items = Array.from(playlistUI.children);
            let scale = 1.0;
            if (items.length > 12) scale = 0.8;
            if (items.length > 20) scale = 0.6;
            document.documentElement.style.setProperty('--tag-scale', scale);

            items.forEach((item, i) => {
                const tag = document.createElement('div');
                tag.className = `song-tag ${useWhiteTags ? 'tag-white' : ''}`;
                tag.innerHTML = `<div class="tag-inner"><span class="tag-index">${i+1}.</span><div class="flex flex-col"><span class="tag-name">${item.dataset.name}</span>${item.dataset.album ? `<span class="tag-album">${item.dataset.album}</span>` : ''}</div></div>`;
                target.appendChild(tag);
            });
        };

        document.getElementById('nickname-input').oninput = (e) => {
            const lines = e.target.value.split('\n');
            document.getElementById('title-container').innerHTML = `<div class="title-main">${lines[0]||''}</div><div class="title-sub">${lines[1]||''}</div>`;
        };

        document.getElementById('bg-upload').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => document.getElementById('capture-zone').style.backgroundImage = `url(${ev.target.result})`;
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('toggle-color').onclick = () => {
            const z = document.getElementById('capture-zone');
            z.style.color = z.style.color === 'white' ? 'black' : 'white';
        };
        document.getElementById('toggle-tag-color').onclick = () => { useWhiteTags = !useWhiteTags; syncPoster(); };

        document.getElementById('export-btn').onclick = async () => {
            const btn = document.getElementById('export-btn');
            btn.innerText = 'è™•ç†ä¸­...';
            const poster = document.getElementById('capture-zone');
            const oldT = poster.style.transform;
            poster.style.transform = 'scale(1)';
            const canvas = await html2canvas(poster, { scale: 2 });
            poster.style.transform = oldT;
            const link = document.createElement('a');
            link.download = 'setlist.png';
            link.href = canvas.toDataURL();
            link.click();
            btn.innerText = 'â¬‡ åŒ¯å‡ºåœ–ç‰‡';
        };

        function autoScale() {
            const wrap = document.getElementById('scale-wrapper');
            const poster = document.getElementById('capture-zone');
            const s = Math.min(1, (wrap.clientWidth - 20) / 592);
            poster.style.transform = `scale(${s})`;
            wrap.style.height = (400 * s + 20) + 'px';
        }
        window.onresize = autoScale;
        autoScale();
    </script>
</body>
</html>