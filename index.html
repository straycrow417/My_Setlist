<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­Œå–®æµ·å ±ç”¢ç”Ÿå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root { --tag-scale: 1; }
        body { font-family: 'Noto Sans JP', 'Noto Sans TC', sans-serif; overflow: hidden; background-color: #18181b; }
        .ghost { opacity: 0.2; background: #3f3f46 !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .poster-size {
            width: 592px; height: 400px; position: relative; overflow: hidden;
            flex-shrink: 0; background-color: #2d5a3a; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .song-tag {
            background-color: rgba(0, 0, 0, 0.6); color: white;
            padding: calc(5px * var(--tag-scale)) calc(10px * var(--tag-scale)); 
            display: inline-block; transform: skewX(-5deg);
            margin-bottom: calc(4px * var(--tag-scale)); margin-left: calc(10px * var(--tag-scale));  
            border-right: calc(2px * var(--tag-scale)) solid rgba(255, 255, 255, 0.2);
            border-bottom: calc(2px * var(--tag-scale)) solid rgba(255, 255, 255, 0.2);
            text-align: left; 
            min-width: fit-content; max-width: 90%; 
            transition: none;
            cursor: grab;
        }
        .song-tag:active {
            cursor: grabbing;
        }

        .song-tag.tag-white {
            background-color: rgba(255, 255, 255, 0.6); color: black;
            border-right: calc(2px * var(--tag-scale)) solid rgba(0, 0, 0, 0.3);
            border-bottom: calc(2px * var(--tag-scale)) solid rgba(0, 0, 0, 0.3);
        }

        .song-tag > .tag-inner {
            transform: skewX(5deg);
            display: flex; 
            align-items: flex-start;
            gap: calc(6px * var(--tag-scale)); 
        }

        .tag-index {
            font-size: calc(13px * var(--tag-scale)); 
            font-weight: 900;
            line-height: 1.1;
            flex-shrink: 0;
            min-width: calc(18px * var(--tag-scale)); 
            text-align: right;
            font-style: italic;
            padding-top: 0.1em;
        }

        .tag-content {
            display: flex;
            flex-direction: column; 
            justify-content: flex-start;
            flex: 1;
        }

        .tag-name {
            display: block;
            font-size: calc(13px * var(--tag-scale));
            font-weight: 900;
            line-height: 1.1; 
            letter-spacing: 0.02em;
            white-space: nowrap; 
        }

        .tag-album {
            display: block;
            font-size: calc(9px * var(--tag-scale));
            font-weight: 400;
            opacity: 0.8;
            line-height: 1.2;
            margin-top: 1px;
            white-space: nowrap; 
        }

        .content-layer { position: relative; z-index: 10; height: 100%; display: flex; flex-direction: column; padding: 24px; box-sizing: border-box; }
        .title-main { font-size: 1.8rem; font-weight: 900; line-height: 1.1; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .title-sub { font-size: 1rem; opacity: 0.8; padding-left: 1em; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        
        #playlist-items { display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-end; justify-content: flex-end; width: 100%; overflow: visible; }
        #capture-zone { background-repeat: no-repeat; background-size: cover; background-position: center; transform-origin: top center; }
        
        .tab-btn.active { border-bottom: 2px solid #22c55e; color: white; }
        input[type=range] { accent-color: #22c55e; height: 4px; border-radius: 2px; }
        .sortable-item { cursor: grab; user-select: none; }

        @media (max-width: 1023px) {
            .mobile-collapsed { height: 40px !important; }
            .mobile-collapsed #right-panel-content { opacity: 0; pointer-events: none; }
            .mobile-collapsed #mobile-panel-icon { transform: rotate(-90deg); }
        }
    </style>
</head>
<body class="text-zinc-100 h-[100dvh] flex flex-col">

    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
        <div class="flex-1 p-4 flex flex-col items-center bg-zinc-800 relative overflow-y-auto pb-10 lg:pb-4">
            <div id="scale-wrapper" class="w-full flex justify-center items-start pt-4 transition-all duration-300">
                <div id="capture-zone" class="poster-size shadow-2xl">
                    <div class="content-layer">
                        <div id="title-container" class="mb-3 flex-shrink-0">
                            <div class="title-main">è«‹åœ¨æ­¤è¼¸å…¥æ­Œå–®æ¨™é¡Œ</div>
                            <div class="title-sub">æ›è¡Œä»¥è¼¸å…¥å‰¯æ¨™é¡Œ</div>
                        </div>
                        <div id="playlist-items"></div>
                    </div>
                </div>
            </div>

            <div class="mt-6 w-full max-w-3xl bg-zinc-700/50 p-5 rounded-2xl border border-zinc-600 backdrop-blur-sm shadow-xl shrink-0">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-3">
                        <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">æ¨™é¡Œæ–‡å­—</p>
                        <textarea id="nickname-input" rows="2" class="w-full bg-zinc-900/80 p-3 rounded-lg text-xs outline-none focus:ring-1 focus:ring-green-500 transition-all font-mono" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ­Œå–®æ¨™é¡Œï¼Œæ›è¡Œä»¥è¼¸å…¥å‰¯æ¨™é¡Œ">è«‹åœ¨æ­¤è¼¸å…¥æ­Œå–®æ¨™é¡Œ&#10;æ›è¡Œä»¥è¼¸å…¥å‰¯æ¨™é¡Œ</textarea>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="toggle-color" class="bg-zinc-600 hover:bg-zinc-500 py-2 rounded text-[10px] transition-colors">æ·±è‰²æ¨™é¡Œ/æ·ºè‰²æ¨™é¡Œ</button>
                            <button id="toggle-tag-color" class="bg-zinc-600 hover:bg-zinc-500 py-2 rounded text-[10px] transition-colors">æ·±è‰²æ­Œå–®/æ·ºè‰²æ­Œå–®</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">åº•åœ–èª¿æ•´</p>
                        <div class="space-y-3 pt-1">
                            <div class="flex flex-col gap-1"><div class="flex justify-between text-[9px] text-zinc-400"><span>åº•åœ–ç¸®æ”¾èª¿æ•´</span><span id="val-scale">100%</span></div><input type="range" id="bg-scale" min="100" max="300" value="100"></div>
                            <div class="flex flex-col gap-1"><div class="flex justify-between text-[9px] text-zinc-400"><span>åº•åœ–æ°´å¹³èª¿æ•´</span><span id="val-x">50%</span></div><input type="range" id="bg-x" min="0" max="100" value="50"></div>
                            <div class="flex flex-col gap-1"><div class="flex justify-between text-[9px] text-zinc-400"><span>åº•åœ–å‚ç›´èª¿æ•´</span><span id="val-y">50%</span></div><input type="range" id="bg-y" min="0" max="100" value="50"></div>
                        </div>
                    </div>
                    <div class="flex flex-col justify-between space-y-3">
                        <div class="flex justify-between items-center">
                            <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest m-0">è¼¸å‡ºèˆ‡æª”æ¡ˆ</p>
                            <button onclick="openTutorial()" class="text-zinc-400 hover:text-white transition-colors outline-none flex items-center gap-1" title="æŸ¥çœ‹ä½¿ç”¨èªªæ˜">
                                <span class="text-[10px] font-bold">ä½¿ç”¨èªªæ˜</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16v-4m0-4h.01"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex-1 flex flex-col gap-2">
                            <label class="flex items-center justify-center gap-2 w-full bg-zinc-100 text-zinc-900 py-3 rounded-xl text-xs font-bold cursor-pointer hover:bg-white transition-all shadow-lg"><span>ğŸ“· ä¸Šå‚³åº•åœ–</span><input type="file" id="bg-upload" accept="image/*" class="hidden"></label>
                            <button id="export-btn" class="w-full bg-green-600 text-white font-black py-4 rounded-xl text-xs shadow-lg hover:bg-green-500 transition-all uppercase tracking-tighter">â¬‡ åŒ¯å‡ºåœ–ç‰‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´/ä¸‹æ–¹æ­Œå–®é¢æ¿ -->
        <div id="right-panel" class="w-full lg:w-[380px] h-[55vh] lg:h-auto bg-zinc-900 border-t lg:border-t-0 lg:border-l border-zinc-800 flex flex-col transition-[height] duration-300 ease-in-out shrink-0 relative z-20 overflow-hidden shadow-[0_-10px_20px_rgba(0,0,0,0.3)] lg:shadow-none">
            
            <button onclick="toggleMobilePanel()" class="lg:hidden w-full h-10 bg-zinc-800 hover:bg-zinc-700 flex items-center justify-center gap-2 shrink-0 transition-colors border-b border-zinc-700 outline-none">
                <span id="mobile-panel-icon" class="text-zinc-400 text-[10px] transition-transform duration-300">â–¼</span>
                <span id="mobile-panel-text" class="text-[11px] font-bold text-zinc-300 tracking-wider">æ”¶èµ·æ­Œå–®é¢æ¿</span>
            </button>

            <!-- é¢æ¿å…§å®¹ -->
            <div id="right-panel-content" class="p-5 flex flex-col flex-1 overflow-hidden transition-opacity duration-300 w-full">
                <div class="flex gap-6 border-b border-zinc-800 mb-5 text-sm font-bold shrink-0">
                    <button id="tab-edit" class="tab-btn pb-3 active transition-all" onclick="switchTab('edit')">ç›®å‰æ­Œå–®</button>
                    <button id="tab-library" class="tab-btn pb-3 text-zinc-500 transition-all" onclick="switchTab('library')">ç¤¾ç¾¤æ­Œåº«</button>
                </div>
                
                <div id="panel-edit" class="flex flex-col flex-1 overflow-hidden relative">
                    <div class="mb-4 space-y-2 shrink-0">
                        <div id="music-search-area" class="flex flex-col gap-2">
                            <div class="flex gap-2">
                                <select id="search-region" class="bg-zinc-800 p-2.5 rounded-lg text-xs border border-zinc-700 outline-none focus:border-[#fa243c] text-zinc-300 flex-shrink-0 cursor-pointer" title="åˆ‡æ›åœ°å€ä»¥ç²å¾—åŸæ–‡æ­Œå">
                                    <option value="TW">TW å°ç£</option>
                                    <option value="JP">JP æ—¥æœ¬</option>
                                    <option value="KR">KR éŸ“åœ‹</option>
                                    <option value="US">US æ­ç¾</option>
                                </select>
                                <input type="text" id="music-query" placeholder="æœå°‹æ­Œæ›²..." class="flex-1 bg-zinc-800 p-2.5 rounded-lg text-xs border border-zinc-700 outline-none focus:border-[#fa243c]">
                                <button id="search-music-btn" class="bg-zinc-700 hover:bg-zinc-600 text-white px-4 rounded-lg text-xs flex-shrink-0">æœå°‹</button>
                            </div>
                            <p class="text-[10px] text-zinc-500 pl-1">ğŸ’¡ è‹¥å‡ºç¾å¤–æ–‡ç¿»è­¯ï¼Œå¯å˜—è©¦åˆ‡æ›ã€Œæœå°‹åœ°å€ã€</p>
                        </div>

                        <details class="group border border-zinc-800 rounded-lg bg-zinc-800/30">
                            <summary class="cursor-pointer p-2 text-[10px] text-zinc-400 select-none flex justify-between items-center">
                                <span>æ‰‹å‹•è¼¸å…¥ / ä¿®æ­£</span>
                                <span class="text-zinc-600 group-open:rotate-180 transition-transform">â–¼</span>
                            </summary>
                            <div class="p-3 pt-0 grid grid-cols-2 gap-2 mt-2">
                                <input type="text" id="custom-name" placeholder="æ­Œå" class="bg-zinc-900 p-2 rounded text-xs border border-zinc-700 outline-none">
                                <input type="text" id="custom-album" placeholder="å°ˆè¼¯" class="bg-zinc-900 p-2 rounded text-xs border border-zinc-700 outline-none">
                                <button id="add-custom-btn" class="col-span-2 bg-zinc-700 hover:bg-zinc-600 text-white py-2 rounded text-xs">+ åŠ å…¥æ­Œå–®</button>
                            </div>
                        </details>
                    </div>

                    <div class="relative flex-1 overflow-hidden">
                        <div id="playlist-view" class="h-full flex flex-col">
                            <div id="playlist-list-ui" class="flex-1 overflow-y-auto space-y-1.5 no-scrollbar pr-1"></div>
                            <div class="flex justify-between items-center mt-3 border-t border-zinc-800 pt-3 shrink-0">
                                <button onclick="toggleBulkModal()" class="text-[11px] text-zinc-400 hover:text-white underline decoration-dotted">æ‰¹æ¬¡åŒ¯å…¥æ–‡å­—</button>
                                <button id="clear-all-btn" class="text-[11px] text-red-500 hover:text-red-400 font-bold">æ¸…ç©ºå…¨éƒ¨</button>
                            </div>
                        </div>

                        <div id="music-results-view" class="hidden absolute inset-0 bg-zinc-900 z-50 flex flex-col h-full">
                            <div class="flex justify-between items-center p-2 bg-zinc-800 border-b border-zinc-700 shrink-0">
                                <span id="search-status" class="text-xs text-zinc-400 truncate pr-2">æœå°‹çµæœ</span>
                                <button id="close-search-btn" class="flex-shrink-0 text-xs bg-zinc-700 px-3 py-1 rounded hover:bg-zinc-600 text-white">è¿”å›</button>
                            </div>
                            <div id="music-results-list" class="flex-1 overflow-y-auto p-2 space-y-1.5 no-scrollbar"></div>
                        </div>
                    </div>
                </div>

                <div id="panel-library" class="hidden flex-1 flex flex-col overflow-hidden">
                    <div class="relative mb-3 flex-shrink-0">
                        <input type="text" id="library-search" placeholder="æœå°‹ç¤¾ç¾¤æ­Œåº«..." class="w-full bg-zinc-800 p-2.5 pl-8 rounded-lg text-xs border border-zinc-700 outline-none">
                        <span class="absolute left-3 top-2.5 opacity-30 text-xs">ğŸ”</span>
                    </div>
                    <div id="library-list-ui" class="flex-1 overflow-y-auto space-y-1.5 pr-1 no-scrollbar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- é å°¾ Footer -->
    <footer class="bg-[#B3D6D8] text-[#1D4E89] py-2 px-4 flex flex-wrap justify-center lg:justify-end items-center gap-4 shrink-0 z-30 shadow-inner">
        <span class="font-bold text-xs tracking-wider">Mitaku Production Presentsï¼š</span>
        
        <div class="flex items-center gap-3">
            <!-- ç¶²ç«™é¦–é  Icon (Home) -->
            <a href="https://mitakuproductiondatabase.notion.site/3fd1711cd6554274b8427167d7b91b53" target="_blank" class="hover:opacity-70 transition-opacity" title="ç¶²ç«™é¦–é ">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </a>
            
            <!-- YouTube Icon -->
            <a href="https://www.youtube.com/@MitakuProduction_Music" target="_blank" class="hover:opacity-70 transition-opacity" title="YouTube">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33 2.78 2.78 0 0 0 1.94 2c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.33 29 29 0 0 0-.46-5.33z"></path>
                    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
                </svg>
            </a>
            
            <!-- Facebook Icon -->
            <a href="https://www.facebook.com/MitakuProductionManuscript" target="_blank" class="hover:opacity-70 transition-opacity" title="Facebook">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
                </svg>
            </a>
            
            <!-- Threads Icon (ä»¥ @ é¢¨æ ¼ç¤ºæ„) -->
            <a href="https://www.threads.com/@straycrow417" target="_blank" class="hover:opacity-70 transition-opacity" title="Threads">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="4"></circle>
                    <path d="M16 12v1.5a2.5 2.5 0 0 0 5 0v-1.5a9 9 0 1 0-5.5 8.28"></path>
                </svg>
            </a>

            <!-- æ–¹æ ¼å­ Icon (ä»¥å››å®®æ ¼ç¤ºæ„) -->
            <a href="https://vocus.cc/salon/66692729fd897800013f217d" target="_blank" class="hover:opacity-70 transition-opacity" title="æ–¹æ ¼å­">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
            </a>
        </div>
    </footer>

    <!-- æ‰¹æ¬¡åŒ¯å…¥ Modal -->
    <div id="bulk-modal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
        <div class="bg-zinc-800 p-8 rounded-2xl w-full max-w-md border border-zinc-700 shadow-2xl">
            <h3 class="font-bold text-lg mb-2">æ‰¹æ¬¡åŒ¯å…¥</h3>
            <p class="text-[10px] text-zinc-500 mb-4">æ ¼å¼ï¼šæ­Œå,å°ˆè¼¯ (ä¸€è¡Œä¸€é¦–)</p>
            <textarea id="bulk-input" rows="8" class="w-full bg-zinc-900 p-4 rounded-xl text-xs mb-6 outline-none focus:ring-1 focus:ring-green-500" placeholder="æ­Œå1,å°ˆè¼¯1&#10;æ­Œå2,å°ˆè¼¯2"></textarea>
            <div class="flex gap-3">
                <button onclick="toggleBulkModal()" class="flex-1 bg-zinc-700 py-3 rounded-xl text-xs font-bold">å–æ¶ˆ</button>
                <button id="bulk-import-btn" class="flex-1 bg-green-600 py-3 rounded-xl text-xs font-bold">é–‹å§‹åŒ¯å…¥</button>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨èªªæ˜ Modal -->
    <div id="tutorial-modal" class="fixed inset-0 bg-black/95 hidden flex flex-col items-center justify-center z-[200] backdrop-blur-md">
        <button onclick="closeTutorial()" class="absolute top-6 right-6 text-zinc-400 hover:text-white bg-zinc-800 hover:bg-zinc-700 p-3 rounded-full transition-colors z-[210] shadow-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>

        <div class="relative w-full max-w-5xl h-[75vh] flex items-center justify-center px-16">
            <button onclick="prevTutorial()" id="tut-prev" class="absolute left-4 lg:left-0 text-white bg-zinc-800/50 hover:bg-green-600 p-4 rounded-full transition-colors disabled:opacity-30 disabled:hover:bg-zinc-800/50 z-[210]">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            
            <img id="tut-img" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl transition-opacity duration-300 select-none" alt="ä½¿ç”¨èªªæ˜">
            
            <button onclick="nextTutorial()" id="tut-next" class="absolute right-4 lg:right-0 text-white bg-zinc-800/50 hover:bg-green-600 p-4 rounded-full transition-colors disabled:opacity-30 disabled:hover:bg-zinc-800/50 z-[210]">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
        
        <div class="mt-8 bg-zinc-800 px-6 py-2 rounded-full border border-zinc-700 shadow-lg flex items-center gap-3">
            <span class="text-zinc-400 text-sm font-bold tracking-widest uppercase">Tutorial</span>
            <div id="tut-counter" class="text-white font-mono text-lg font-bold">1 / 1</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === æ‰‹æ©Ÿç‰ˆé¢æ¿æ”¶åˆé‚è¼¯ ===
        let isMobilePanelOpen = true;
        window.toggleMobilePanel = () => {
            const panel = document.getElementById('right-panel');
            const text = document.getElementById('mobile-panel-text');
            isMobilePanelOpen = !isMobilePanelOpen;
            if (isMobilePanelOpen) {
                panel.classList.remove('mobile-collapsed'); text.innerText = 'æ”¶èµ·æ­Œå–®é¢æ¿';
            } else {
                panel.classList.add('mobile-collapsed'); text.innerText = 'å±•é–‹æ­Œå–®é¢æ¿';
            }
            setTimeout(autoScale, 300);
        };

        // === é›»è…¦ç‰ˆèˆ‡æ‰‹æ©Ÿç‰ˆçš„å…©çµ„ç›¸ç°¿ ===
        const tutorialImagesDesktop = [
            "https://mitakuproductiondatabase.notion.site/image/attachment%3Af417ed85-171d-41e7-883c-31720bd2011e%3A%E6%8A%95%E5%BD%B1%E7%89%871.png?table=block&id=310ec1d7-4290-80cd-a74c-dd51b512925a&spaceId=0b9ae6ca-d241-44a9-a9e0-ded5a78f696c&width=1420&userId=&cache=v2.png", 
            "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1000&auto=format&fit=crop", 
            "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1000&auto=format&fit=crop"  
        ];

        const tutorialImagesMobile = [
            "https://i.imgur.com/ac6GcaS.png", 
            "https://images.unsplash.com/photo-1525547719571-a2d4ac8945e2?q=80&w=800&auto=format&fit=crop"
        ];

        let currentTutorialImages = [];
        let currentTutorialStep = 0;

        window.openTutorial = () => {
            if (window.innerWidth < 1024) currentTutorialImages = tutorialImagesMobile;
            else currentTutorialImages = tutorialImagesDesktop;

            if(currentTutorialImages.length === 0) { alert("å°šæœªè¨­å®šèªªæ˜åœ–ç‰‡ï¼"); return; }
            currentTutorialStep = 0;
            document.getElementById('tutorial-modal').classList.remove('hidden');
            document.getElementById('tutorial-modal').classList.add('flex');
            updateTutorialView();
        };

        window.closeTutorial = () => {
            document.getElementById('tutorial-modal').classList.add('hidden');
            document.getElementById('tutorial-modal').classList.remove('flex');
        };

        window.prevTutorial = () => {
            if(currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialView();
            }
        };

        window.nextTutorial = () => {
            if(currentTutorialStep < currentTutorialImages.length - 1) {
                currentTutorialStep++;
                updateTutorialView();
            }
        };

        function updateTutorialView() {
            const imgEl = document.getElementById('tut-img');
            const prevBtn = document.getElementById('tut-prev');
            const nextBtn = document.getElementById('tut-next');
            const counter = document.getElementById('tut-counter');

            imgEl.style.opacity = '0';
            setTimeout(() => {
                imgEl.src = currentTutorialImages[currentTutorialStep];
                imgEl.onload = () => { imgEl.style.opacity = '1'; };
            }, 150);

            counter.innerText = `${currentTutorialStep + 1} / ${currentTutorialImages.length}`;
            prevBtn.disabled = currentTutorialStep === 0;
            nextBtn.disabled = currentTutorialStep === currentTutorialImages.length - 1;
        }

        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('tutorial-modal');
            if(!modal.classList.contains('hidden')) {
                if(e.key === 'ArrowRight') window.nextTutorial();
                if(e.key === 'ArrowLeft') window.prevTutorial();
                if(e.key === 'Escape') window.closeTutorial();
            }
        });

        // æ ¸å¿ƒæ¥­å‹™é‚è¼¯
        const manualConfig = { apiKey: "AIzaSyDhP9JryXni2a6SOka73Lgng80DBwg0esI",
  authDomain: "my-setlist-25d7a.firebaseapp.com",
  projectId: "my-setlist-25d7a",
  storageBucket: "my-setlist-25d7a.firebasestorage.app",
  messagingSenderId: "723230839513",
  appId: "1:723230839513:web:307d5221fada859e6f24c8" };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : manualConfig;
        let db = null, auth = null, user = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-poster-app';
        let allLibrarySongs = [];
        let currentAudio = null; let currentlyPlayingElement = null;

        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app); db = getFirestore(app);
                const startAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (err) { console.warn("é©—è­‰å¤±æ•—:", err); }
                };
                onAuthStateChanged(auth, u => { user = u; if (user) listenToLibrary(); });
                startAuth();
            } catch(e) { console.error("FB Init Error", e); }
        }

        window.togglePreview = async (e, element) => {
            e.stopPropagation(); 
            const previewUrl = element.getAttribute('data-preview'); 
            const appleUrl = element.getAttribute('data-apple'); 
            const iconEl = element.querySelector('.play-icon');
            
            document.querySelectorAll('.play-icon').forEach(el => { if (el !== iconEl) el.innerText = 'â–¶'; });
            
            if (currentAudio && currentlyPlayingElement === element) { 
                if (!currentAudio.paused) { currentAudio.pause(); iconEl.innerText = 'â–¶'; } 
                else { currentAudio.play(); iconEl.innerText = 'â¸'; } 
                return; 
            }
            
            if (!previewUrl || previewUrl === 'null' || previewUrl === '') {
                iconEl.innerText = 'â–¶'; 
                if(confirm('Apple Music æš«æœªæä¾›æ­¤æ­Œæ›²é è¦½ã€‚\næ˜¯å¦å‰å¾€ Apple Music é é¢æŸ¥çœ‹ï¼Ÿ')) window.open(appleUrl, '_blank'); 
                return; 
            }
            
            if (currentAudio) currentAudio.pause(); 
            currentAudio = new Audio(previewUrl); 
            currentAudio.volume = 0.5; 
            currentlyPlayingElement = element; 
            iconEl.innerText = 'â³';
            
            currentAudio.play().then(() => { iconEl.innerText = 'â¸'; }).catch(err => { iconEl.innerText = 'â–¶'; }); 
            currentAudio.onended = () => { iconEl.innerText = 'â–¶'; currentlyPlayingElement = null; };
        };

        async function searchAppleMusic() {
            const q = document.getElementById('music-query').value.trim(); 
            if (!q) return;
            
            const region = document.getElementById('search-region').value || 'TW';
            const langMap = { 'TW': 'zh_tw', 'JP': 'ja_jp', 'US': 'en_us', 'KR': 'ko_kr' };
            const lang = langMap[region] || 'zh_tw';
            
            document.getElementById('playlist-view').classList.add('hidden'); 
            const resultsView = document.getElementById('music-results-view'); 
            const resultsList = document.getElementById('music-results-list'); 
            const status = document.getElementById('search-status');
            
            resultsView.classList.remove('hidden'); 
            resultsList.innerHTML = ''; 
            status.innerText = 'æœå°‹ä¸­...';
            
            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&media=music&entity=song&limit=25&country=${region}&lang=${lang}`);
                const data = await res.json(); 
                
                status.innerText = `çµæœï¼š${data.results.length} ç­†`;
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(track => {
                        const div = document.createElement('div'); 
                        div.className = 'flex justify-between items-center py-1.5 px-2 hover:bg-zinc-800 rounded-lg border border-transparent hover:border-zinc-700/50 transition-colors group/item';
                        
                        const imgUrl = track.artworkUrl100 || ''; 
                        const songName = track.trackName || 'æœªçŸ¥æ­Œæ›²';
                        const originalAlbumName = track.collectionName || track.artistName || 'æœªçŸ¥å°ˆè¼¯';
                        
                        let cleanAlbumName = originalAlbumName
                            .replace(/\s*[\(\[-]?\s*(Special|Deluxe)\s*Edition\s*[\)\]]?\s*/gi, '')
                            .replace(/\s*-\s*(Single|EP|E\.P\.)\s*$/gi, '')
                            .trim();
                        
                        div.innerHTML = `
                            <div class="relative w-9 h-9 flex-shrink-0 mr-3 cursor-pointer group/img preview-trigger">
                                ${imgUrl ? `<img src="${imgUrl}" class="w-full h-full object-cover rounded shadow-sm" alt="cover">` : `<div class="w-full h-full bg-zinc-700 rounded"></div>`}
                                <div class="absolute inset-0 bg-black/60 flex items-center justify-center rounded opacity-0 group-hover/img:opacity-100 transition-opacity">
                                    <span class="text-white text-xs play-icon">â–¶</span>
                                </div>
                            </div>
                            <div class="truncate mr-2 flex-1 min-w-0 cursor-pointer" onclick="addSong('${songName.replace(/'/g, "\\'")}', '${cleanAlbumName.replace(/'/g, "\\'")}'); saveToCloud('${songName.replace(/'/g, "\\'")}', '${cleanAlbumName.replace(/'/g, "\\'")}');">
                                <div class="text-xs font-bold text-zinc-200 truncate">${songName}</div>
                                <div class="text-[10px] text-zinc-500 truncate">${track.artistName} - ${originalAlbumName}</div>
                            </div>
                            <button class="text-green-500 font-bold text-lg px-2 flex-shrink-0 hover:scale-110 transition-transform" onclick="addSong('${songName.replace(/'/g, "\\'")}', '${cleanAlbumName.replace(/'/g, "\\'")}'); saveToCloud('${songName.replace(/'/g, "\\'")}', '${cleanAlbumName.replace(/'/g, "\\'")}');">+</button>
                        `;
                        
                        const trigger = div.querySelector('.preview-trigger'); 
                        trigger.setAttribute('data-preview', track.previewUrl || ''); 
                        trigger.setAttribute('data-apple', track.trackViewUrl || ''); 
                        trigger.onclick = (e) => togglePreview(e, trigger);
                        
                        resultsList.appendChild(div);
                    });
                } else {
                    resultsList.innerHTML = '<div class="text-center text-xs text-zinc-500 py-6">æ‰¾ä¸åˆ°ç›¸é—œæ­Œæ›²</div>';
                }
            } catch(e) { 
                status.innerText = `æœå°‹å¤±æ•—`; 
            }
        }
        
        document.getElementById('search-music-btn').onclick = searchAppleMusic;
        document.getElementById('close-search-btn').onclick = () => { 
            if (currentAudio) { currentAudio.pause(); currentAudio = null; currentlyPlayingElement = null; } 
            document.getElementById('music-results-view').classList.add('hidden'); 
            document.getElementById('playlist-view').classList.remove('hidden'); 
            document.getElementById('music-query').value = ''; 
        };

        let useWhiteTags = false; let bgStyle = { scale: 100, x: 50, y: 50 };
        const posterContainer = document.getElementById('playlist-items'); const playlistUI = document.getElementById('playlist-list-ui');
        
        Sortable.create(posterContainer, { animation: 200, ghostClass: 'ghost', onEnd: () => syncOrderFromPoster() });

        window.addSong = (name, album) => { const id = 's-' + Date.now() + Math.random().toString(36).substr(2, 4); const tag = document.createElement('div'); tag.className = `song-tag ${useWhiteTags ? 'tag-white' : ''}`; tag.setAttribute('data-id', id); tag.setAttribute('data-name', name); tag.setAttribute('data-album', album || ''); posterContainer.appendChild(tag); syncOrderFromPoster(); };
        window.deleteSong = (id) => { const tag = posterContainer.querySelector(`[data-id="${id}"]`); if (tag) tag.remove(); syncOrderFromPoster(); };

        function syncOrderFromPoster() {
            updateIndices(); playlistUI.innerHTML = '';
            Array.from(posterContainer.children).forEach((tag, index) => {
                const id = tag.getAttribute('data-id'); const name = tag.getAttribute('data-name'); const li = document.createElement('div');
                li.className = 'flex items-center justify-between py-2 px-3 bg-zinc-800 rounded-lg border border-zinc-700/50 hover:border-zinc-600 transition-colors group w-full gap-2';
                li.innerHTML = `<div class="flex-1 flex items-center min-w-0"><span class="text-[10px] text-zinc-500 w-5 flex-shrink-0 text-right pr-2">${index + 1}.</span><span class="font-bold text-xs text-zinc-200 truncate select-none" title="${name}">${name}</span></div><button onclick="deleteSong('${id}')" class="flex-shrink-0 text-zinc-500 hover:text-red-400 p-1 opacity-50 group-hover:opacity-100 transition-all outline-none flex items-center justify-center" title="ç§»é™¤"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
                playlistUI.appendChild(li);
            });
        }

        function updateIndices() {
            let scale = 1.0; document.documentElement.style.setProperty('--tag-scale', scale);
            const titleH = document.getElementById('title-container').offsetHeight; const availableH = 400 - 48 - titleH - 10; posterContainer.style.height = `${availableH}px`;
            const items = Array.from(posterContainer.children);
            items.forEach((tag, i) => {
                const name = tag.getAttribute('data-name'); const album = tag.getAttribute('data-album'); tag.className = `song-tag ${useWhiteTags ? 'tag-white' : ''}`;
                tag.innerHTML = `<div class="tag-inner"><span class="tag-index">${i + 1}.</span><div class="tag-content"><span class="tag-name">${name}</span>${album ? `<span class="tag-album">(from ${album})</span>` : ''}</div></div>`;
            });
            setTimeout(() => checkOverflowAndShrink(availableH, 1.0), 0);
        }

        function checkOverflowAndShrink(availableHeight, currentScale) {
            if (currentScale < 0.4) return;
            const containerRect = document.querySelector('.content-layer').getBoundingClientRect(); const limitLeft = containerRect.left + 24; let minLeft = Infinity;
            Array.from(posterContainer.children).forEach(tag => { const r = tag.getBoundingClientRect(); if (r.left < minLeft) minLeft = r.left; });
            if (minLeft < limitLeft) { const nextScale = currentScale - 0.05; document.documentElement.style.setProperty('--tag-scale', nextScale); setTimeout(() => checkOverflowAndShrink(availableHeight, nextScale), 0); }
        }

        window.saveToCloud = async (name, album) => { 
            if (!db || !user) return; 
            const id = btoa(encodeURIComponent(name + album)).substring(0, 24).replace(/[/+=]/g, '_'); 
            try { 
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'song_library', id), { name, album: album || '', time: serverTimestamp() }, { merge: true }); 
            } catch(e) {} 
        };

        function listenToLibrary() { if (!db) return; onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'song_library'), (snap) => { allLibrarySongs = snap.docs.map(doc => doc.data()).sort((a,b) => (b.time?.seconds||0) - (a.time?.seconds||0)); renderLibrary(); }); }

        function renderLibrary(filter = '') {
            const libUI = document.getElementById('library-list-ui'); libUI.innerHTML = ''; const filtered = allLibrarySongs.filter(s => s.name.toLowerCase().includes(filter) || (s.album||'').toLowerCase().includes(filter));
            if(filtered.length===0) { libUI.innerHTML = '<div class="text-center text-zinc-500 py-10 text-xs">ç„¡çµæœ</div>'; return; }
            filtered.forEach(d => {
                const btn = document.createElement('div'); btn.className = 'py-2 px-3 bg-zinc-800/50 rounded-lg cursor-pointer hover:bg-zinc-700 border border-transparent hover:border-zinc-600 transition-all flex justify-between items-center group gap-2 w-full';
                btn.innerHTML = `<div class="flex-1 min-w-0 pr-2"><div class="font-bold text-xs text-zinc-200 truncate" title="${d.name}">${d.name}</div><div class="text-[10px] text-zinc-500 truncate mt-0.5" title="${d.album}">${d.album}</div></div><span class="text-green-500 font-bold opacity-0 group-hover:opacity-100 flex-shrink-0 px-2">+</span>`;
                btn.onclick = () => { addSong(d.name, d.album); saveToCloud(d.name, d.album); }; libUI.appendChild(btn);
            });
        }

        document.getElementById('library-search').oninput = (e) => renderLibrary(e.target.value.toLowerCase());
        document.getElementById('music-query').onkeypress = (e) => { if(e.key === 'Enter') document.getElementById('search-music-btn').click(); };
        document.getElementById('nickname-input').oninput = (e) => { const lines = e.target.value.split('\n'); document.getElementById('title-container').innerHTML = `<div class="title-main">${lines[0]||''}</div><div class="title-sub">${lines[1]||''}</div>`; updateIndices(); };

        window.switchTab = (tab) => { document.getElementById('panel-edit').classList.toggle('hidden', tab !== 'edit'); document.getElementById('panel-library').classList.toggle('hidden', tab !== 'library'); document.getElementById('tab-edit').className = `tab-btn pb-3 transition-all ${tab === 'edit' ? 'active text-white' : 'text-zinc-500'}`; document.getElementById('tab-library').className = `tab-btn pb-3 transition-all ${tab === 'library' ? 'active text-white' : 'text-zinc-500'}`; };
        window.toggleBulkModal = () => document.getElementById('bulk-modal').classList.toggle('hidden');
        document.getElementById('bulk-import-btn').onclick = () => { document.getElementById('bulk-input').value.split('\n').forEach(l => { const p=l.split(/[,\t]/); if(p[0]) { addSong(p[0].trim(), (p[1]||'').trim()); saveToCloud(p[0].trim(), (p[1]||'').trim()); } }); toggleBulkModal(); };
        document.getElementById('add-custom-btn').onclick = () => { const n = document.getElementById('custom-name'); const a = document.getElementById('custom-album'); if(n.value) { addSong(n.value, a.value); saveToCloud(n.value, a.value); n.value=''; a.value=''; } };
        document.getElementById('clear-all-btn').onclick = () => { if(confirm('ç¢ºå®šè¦æ¸…ç©ºæµ·å ±ä¸Šæ‰€æœ‰æ­Œæ›²å—?')) { posterContainer.innerHTML=''; syncOrderFromPoster(); } };

        document.getElementById('bg-upload').onchange = (e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = (ev) => { document.getElementById('capture-zone').style.backgroundImage = `url(${ev.target.result})`; document.getElementById('capture-zone').style.color='white'; }; r.readAsDataURL(f); } };

        document.getElementById('bg-scale').oninput = (e) => { bgStyle.scale = e.target.value; document.getElementById('val-scale').innerText = e.target.value + '%'; updateBg(); }; 
        document.getElementById('bg-x').oninput = (e) => { bgStyle.x = e.target.value; document.getElementById('val-x').innerText = e.target.value + '%'; updateBg(); }; 
        document.getElementById('bg-y').oninput = (e) => { bgStyle.y = e.target.value; document.getElementById('val-y').innerText = e.target.value + '%'; updateBg(); };
        function updateBg() { const z = document.getElementById('capture-zone'); z.style.backgroundSize = `${bgStyle.scale}%`; z.style.backgroundPosition = `${bgStyle.x}% ${bgStyle.y}%`; }
        
        document.getElementById('toggle-color').onclick = () => { const z = document.getElementById('capture-zone'); z.style.color = z.style.color === 'white' ? 'black' : 'white'; };
        document.getElementById('toggle-tag-color').onclick = () => { useWhiteTags = !useWhiteTags; updateIndices(); };
        
        document.getElementById('export-btn').onclick = async () => { const poster = document.getElementById('capture-zone'); const t = poster.style.transform; poster.style.transform = 'scale(1)'; const c = await html2canvas(poster, { scale: 3, useCORS: true }); poster.style.transform = t; const a = document.createElement('a'); a.download = 'My_Setlist.png'; a.href = c.toDataURL(); a.click(); };

        const autoScale = () => { 
            const wrapper = document.getElementById('scale-wrapper');
            const poster = document.getElementById('capture-zone');
            if (!wrapper || !poster) return;
            const containerWidth = wrapper.parentElement.clientWidth;
            const scale = Math.min(1, (containerWidth - 32) / 592);
            poster.style.transform = `scale(${scale})`;
            wrapper.style.height = `${(400 * scale) + 20}px`;
        };
        
        window.addEventListener('resize', autoScale);
        window.addEventListener('load', autoScale);
        setTimeout(autoScale, 100);

    </script>
</body>
</html>